<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IGPHS Chatroom</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #007BFF;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    #sidebar {
      width: 220px;
      background-color: #000;
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 12px;
      box-sizing: border-box;
    }
    #sidebar h2 {
      margin: 0 0 10px;
      font-size: 16px;
      letter-spacing: 1px;
    }
    .room {
      padding: 10px;
      margin-bottom: 6px;
      background-color: #151515;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
    }
    .room.active { background-color: #1E90FF; color: #fff; }
    .room:hover { background-color: #333; }

    #addRoomBtn, #joinRoomBtn {
      margin-top: 6px;
      padding: 10px;
      background-color: #1E90FF;
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    /* Main chat area */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 12px;
      box-sizing: border-box;
    }
    #chatHeader {
      background-color: #000;
      color: #fff;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #chatbox {
      flex: 1;
      background-color: #000;
      padding: 12px;
      border-radius: 12px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .message {
      max-width: 70%;
      margin: 6px 0;
      padding: 10px 14px;
      border-radius: 20px;
      animation: popIn 0.25s ease-out;
      word-wrap: break-word;
    }
    .self { background-color: #28a745; color: #fff; align-self: flex-end; }
    .other { background-color: #fff; color: #000; align-self: flex-start; }

    .system-message {
      text-align: center;
      color: #ccc;
      font-size: 14px;
      margin: 10px 0;
      animation: fadeIn 0.2s ease-out;
    }

    #inputArea {
      display: flex;
      margin-top: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 20px;
      padding: 8px;
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: none;
      font-size: 16px;
      margin-right: 10px;
      outline: none;
    }
    #sendBtn {
      padding: 10px 16px;
      border-radius: 50%;
      border: none;
      background-color: #28a745;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
    }

    /* Avatar */
    #userAvatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #fff;
      background: #28a745;
    }

    /* Modals */
    .modal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 18px;
      border-radius: 15px;
      width: 320px; /* ~10% visual footprint */
      z-index: 1000;
      display: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }
    .modal h3 { margin: 0 0 10px; }
    .modal input {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .modal .row { display: flex; align-items: center; gap: 10px; }
    .modal .avatarPreview {
      width: 36px; height: 36px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-weight: bold; background: #28a745;
    }
    .modal button {
      background-color: #007BFF;
      color: #fff;
      border: none;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
      font-weight: bold;
    }

    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      display: none;
    }

    @keyframes popIn {
      0% { transform: scale(0.9); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>ROOMS</h2>
    <div id="roomList"></div>
    <button id="addRoomBtn">+ Add Room</button>
    <button id="joinRoomBtn">Join Room</button>
  </div>

  <div id="main">
    <div id="chatHeader">
      <div id="roomName">general</div>
      <div id="userAvatar">?</div>
    </div>
    <div id="chatbox"></div>
    <div id="inputArea">
      <input type="text" id="messageInput" placeholder="Type a message..." />
      <button id="sendBtn">➤</button>
    </div>
  </div>

  <!-- Overlay -->
  <div id="overlay"></div>

  <!-- Username Setup Modal -->
  <div id="usernameModal" class="modal">
    <h3>Choose a username</h3>
    <div class="row">
      <input type="text" id="usernameInput" placeholder="Username" />
      <div id="avatarPreview" class="avatarPreview">?</div>
    </div>
    <input type="color" id="colorInput" value="#28a745" />
    <button id="usernameOkBtn">OK</button>
  </div>

  <!-- Add Room Modal -->
  <div id="roomModal" class="modal">
    <h3>Create a private room</h3>
    <input type="text" id="newRoomInput" placeholder="Room name" />
    <button id="createRoomBtn">OK</button>
  </div>

  <!-- Join Room Modal -->
  <div id="joinRoomModal" class="modal">
    <h3>Join a room</h3>
    <input type="text" id="joinRoomInput" placeholder="Room name" />
    <button id="joinRoomConfirmBtn">OK</button>
  </div>

  <script>
    // Elements
    const overlay = document.getElementById('overlay');
    const usernameModal = document.getElementById('usernameModal');
    const roomModal = document.getElementById('roomModal');
    const joinRoomModal = document.getElementById('joinRoomModal');

    const usernameInput = document.getElementById('usernameInput');
    const colorInput = document.getElementById('colorInput');
    const usernameOkBtn = document.getElementById('usernameOkBtn');
    const avatarPreview = document.getElementById('avatarPreview');
    const userAvatar = document.getElementById('userAvatar');

    const roomListEl = document.getElementById('roomList');
    const roomNameEl = document.getElementById('roomName');
    const addRoomBtn = document.getElementById('addRoomBtn');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const newRoomInput = document.getElementById('newRoomInput');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomInput = document.getElementById('joinRoomInput');
    const joinRoomConfirmBtn = document.getElementById('joinRoomConfirmBtn');

    const chatbox = document.getElementById('chatbox');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    // State
    let currentUser = localStorage.getItem('username') || null;
    let userColor = localStorage.getItem('userColor') || '#28a745';
    let currentRoom = localStorage.getItem('currentRoom') || 'general';

    // Rooms & Messages persisted locally
    let rooms = JSON.parse(localStorage.getItem('rooms') || '["general"]');
    let messages = JSON.parse(localStorage.getItem('messages') || '{}');

    // Helpers
    function showModal(modal) {
      overlay.style.display = 'block';
      modal.style.display = 'block';
    }
    function hideModal(modal) {
      overlay.style.display = 'none';
      modal.style.display = 'none';
    }
    function saveState() {
      localStorage.setItem('rooms', JSON.stringify(rooms));
      localStorage.setItem('messages', JSON.stringify(messages));
      localStorage.setItem('currentRoom', currentRoom);
    }

    function renderAvatar() {
      const letter = (currentUser || '?').charAt(0).toUpperCase();
      userAvatar.style.background = userColor;
      userAvatar.textContent = letter;
    }

    function renderRoomList() {
      roomListEl.innerHTML = '';
      rooms.forEach(room => {
        const div = document.createElement('div');
        div.className = 'room' + (room === currentRoom ? ' active' : '');
        div.textContent = room;
        div.dataset.room = room;
        div.addEventListener('click', () => switchRoom(room));
        roomListEl.appendChild(div);
      });
    }

    function switchRoom(room) {
      currentRoom = room;
      roomNameEl.textContent = room;
      renderRoomList();
      renderMessages();
      saveState();
    }

    function renderMessages() {
      chatbox.innerHTML = '';
      const roomMsgs = messages[currentRoom] || [];
      roomMsgs.forEach(msg => {
        if (msg.type === 'system') {
          const s = document.createElement('div');
          s.className = 'system-message';
          s.textContent = '— ' + msg.text + ' —';
          chatbox.appendChild(s);
        } else {
          const div = document.createElement('div');
          div.className = 'message ' + msg.type;
          // Show sender name above bubble if available
          if (msg.sender) {
            const nameTag = document.createElement('div');
            nameTag.style.fontSize = '12px';
            nameTag.style.fontWeight = 'bold';
            nameTag.style.marginBottom = '4px';
            nameTag.style.opacity = '0.85';
            nameTag.textContent = msg.sender;
            div.prepend(nameTag);
          }
          div.appendChild(document.createTextNode(msg.text));
          chatbox.appendChild(div);
        }
      });
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function postSystemMessage(text) {
      messages[currentRoom] = messages[currentRoom] || [];
      messages[currentRoom].push({ type: 'system', text });
      saveState();
      renderMessages();
    }

    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      messages[currentRoom] = messages[currentRoom] || [];
      messages[currentRoom].push({
        text,
        type: 'self',
        sender: currentUser || 'Anonymous'
      });
      messageInput.value = '';
      saveState();
      renderMessages();
    }

    // Events
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });

    addRoomBtn.addEventListener('click', () => {
      newRoomInput.value = '';
      showModal(roomModal);
      newRoomInput.focus();
    });

    createRoomBtn.addEventListener('click', () => {
      const room = newRoomInput.value.trim();
      if (!room) return;
      if (!rooms.includes(room)) {
        rooms.push(room);
        messages[room] = messages[room] || [{ type: 'system', text: `Room "${room}" created` }];
      }
      hideModal(roomModal);
      switchRoom(room);
      saveState();
    });

    joinRoomBtn.addEventListener('click', () => {
      joinRoomInput.value = '';
      showModal(joinRoomModal);
      joinRoomInput.focus();
    });

    joinRoomConfirmBtn.addEventListener('click', () => {
      const room = joinRoomInput.value.trim();
      if (!room) return;
      if (!rooms.includes(room)) {
        // "Private until shared": create locally, becomes accessible when others know the name
        rooms.push(room);
        messages[room] = messages[room] || [{ type: 'system', text: `Joined private room "${room}"` }];
      } else {
        messages[room].push({ type: 'system', text: `You joined "${room}"` });
      }
      hideModal(joinRoomModal);
      switchRoom(room);
      saveState();
    });

    // Overlay closes any open modal
    overlay.addEventListener('click', () => {
      hideModal(usernameModal);
      hideModal(roomModal);
      hideModal(joinRoomModal);
    });

    // Username modal behavior
    function openUsernameModalIfNeeded() {
      if (!currentUser) {
        usernameInput.value = '';
        avatarPreview.style.background = userColor;
        avatarPreview.textContent = '?';
        showModal(usernameModal);
        usernameInput.focus();
      } else {
        renderAvatar();
      }
    }

    usernameInput.addEventListener('input', () => {
      const letter = usernameInput.value.trim().charAt(0).toUpperCase() || '?';
      avatarPreview.textContent = letter;
    });
    colorInput.addEventListener('input', () => {
      avatarPreview.style.background = colorInput.value;
    });

    usernameOkBtn.addEventListener('click', () => {
      const name = usernameInput.value.trim() || 'Anonymous';
      const color = colorInput.value || '#28a745';
      currentUser = name;
      userColor = color;
      localStorage.setItem('username', currentUser);
      localStorage.setItem('userColor', userColor);
      hideModal(usernameModal);
      renderAvatar();
      // Welcome message in current room
      postSystemMessage(`${currentUser} joined`);
    });

    // Init
    (function init() {
      // Ensure "general" room exists
      if (!rooms.includes('general')) rooms.unshift('general');
      renderRoomList();
      switchRoom(currentRoom);
      openUsernameModalIfNeeded();
      renderMessages();
    })();

    // Local-only offline note
    window.addEventListener('beforeunload', () => {
      messages[currentRoom] = messages[currentRoom] || [];
      messages[currentRoom].push({ type: 'system', text: `${currentUser || 'Anonymous'} has gone offline` });
      saveState();
    });
  </script>
</body>
</html>
