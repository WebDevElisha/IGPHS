<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IGPHS Chatroom — Baseline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --blue:#007BFF; --accent:#1E90FF; --green:#28a745; --bg:#000; --text:#fff; }
    body { margin:0; font-family:Arial,sans-serif; background:var(--blue); display:flex; height:100vh; overflow:hidden; }
    #sidebar { width:240px; background:var(--bg); color:var(--text); padding:12px; box-sizing:border-box; display:flex; flex-direction:column; }
    #sidebar h2 { margin:0 0 10px; font-size:16px; }
    .room { padding:10px; margin-bottom:6px; background:#151515; border-radius:10px; cursor:pointer; }
    .room.active { background:var(--accent); }
    #addRoomBtn,#joinRoomBtn { margin-top:6px; padding:10px; background:var(--accent); color:#fff; border:none; border-radius:10px; cursor:pointer; }
    #main { flex:1; display:flex; flex-direction:column; padding:12px; box-sizing:border-box; }
    #chatHeader { background:var(--bg); color:#fff; padding:12px; border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
    #roomTitle { display:flex; align-items:center; gap:10px; }
    #userAvatar { width:32px; height:32px; border-radius:50%; background:var(--green); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:bold; }
    #chatbox { flex:1; background:var(--bg); color:#fff; border-radius:12px; padding:12px; overflow-y:auto; display:flex; flex-direction:column; }
    .message { max-width:72%; padding:8px 12px; margin:6px 0; border-radius:14px; }
    .self { background:var(--green); align-self:flex-end; }
    .other { background:#fff; color:#000; align-self:flex-start; }
    .system { text-align:center; color:#ccc; margin:6px 0; }
    #inputArea { display:flex; gap:8px; margin-top:8px; }
    #messageInput { flex:1; padding:10px; border-radius:20px; border:none; }
    #sendBtn { padding:10px 16px; border:none; border-radius:20px; background:var(--green); color:#fff; cursor:pointer; }
    #statusBox { position:fixed; bottom:10px; left:10px; background:#000; color:#fff; border:1px solid var(--accent); border-radius:10px; font-size:14px; cursor:pointer; }
    #statusLabel { padding:8px 12px; }
    #statusOptions { display:none; flex-direction:column; border-top:1px solid var(--accent); }
    .statusOption { padding:8px 12px; border-top:1px solid #333; background:#111; cursor:pointer; }
    .statusOption:hover { background:#222; }
    .modal { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:16px; border-radius:12px; display:none; width:320px; }
    #overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; }
  </style>
</head>
<body>
  <div id="overlay"></div>

  <div id="sidebar">
    <h2>ROOMS</h2>
    <div id="roomList"></div>
    <button id="addRoomBtn">+ Add Room</button>
    <button id="joinRoomBtn">Join Room</button>
  </div>

  <div id="main">
    <div id="chatHeader">
      <div id="roomTitle">
        <strong>IGPHS</strong>
        <span id="roomName">General</span>
      </div>
      <div id="userAvatar">?</div>
    </div>

    <div id="chatbox"></div>

    <div id="inputArea">
      <input id="messageInput" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <div id="statusBox">
    <div id="statusLabel">Status: Online</div>
    <div id="statusOptions">
      <div class="statusOption" data-status="Online">Online</div>
      <div class="statusOption" data-status="DND">Do Not Disturb</div>
      <div class="statusOption" data-status="Offline">Offline</div>
    </div>
  </div>

  <!-- Username Modal -->
  <div id="usernameModal" class="modal">
    <h3>Choose a username</h3>
    <input id="usernameInput" placeholder="Username" />
    <button id="usernameOkBtn">OK</button>
  </div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getDatabase, ref, set, push, onChildAdded, onValue, onDisconnect, off, get } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCgkxFC2qZSTWTHfl8OgjYBNaN0rfYjaQU",
    authDomain: "igphs-acebf.firebaseapp.com",
    databaseURL: "https://igphs-acebf-default-rtdb.firebaseio.com",
    projectId: "igphs-acebf",
    storageBucket: "igphs-acebf.firebasestorage.app",
    messagingSenderId: "50789789074",
    appId: "1:50789789074:web:47598a87a8c684fea1e54b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Elements
  const overlay = document.getElementById('overlay');
  const roomListEl = document.getElementById('roomList');
  const roomNameEl = document.getElementById('roomName');
  const userAvatar = document.getElementById('userAvatar');
  const chatbox = document.getElementById('chatbox');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const addRoomBtn = document.getElementById('addRoomBtn');
  const joinRoomBtn = document.getElementById('joinRoomBtn');
  const statusLabel = document.getElementById('statusLabel');
  const statusOptions = document.getElementById('statusOptions');
  const usernameModal = document.getElementById('usernameModal');
  const usernameInput = document.getElementById('usernameInput');
  const usernameOkBtn = document.getElementById('usernameOkBtn');

  // State
  let uid = localStorage.getItem('uid'); if(!uid){ uid='u_'+Math.random().toString(36).slice(2,10); localStorage.setItem('uid',uid); }
  let currentUser = localStorage.getItem('username'); if(!currentUser){ currentUser='Anonymous'; localStorage.setItem('username', currentUser); }
  let currentRoom = localStorage.getItem('currentRoom') || 'General';
  let currentStatus = 'Online';

  function renderAvatar(){
    userAvatar.textContent = (currentUser || 'Anonymous').charAt(0).toUpperCase();
  }

  async function seedGeneral(){
    await set(ref(db, `rooms/General/meta`), { owner:'system', isPrivate:false, createdAt: Date.now() });
    await set(ref(db, `userRooms/${uid}/General`), { private:false });
  }

  // Room list
  let userRoomsRef = null;
  function renderRoomList(){
    if (userRoomsRef) off(userRoomsRef);
    userRoomsRef = ref(db, `userRooms/${uid}`);
    onValue(userRoomsRef, async (snap)=>{
      const roomsObj = snap.val() || {};
      if (!roomsObj.General) { await seedGeneral(); }
      const entries = Object.entries(roomsObj).sort((a,b)=>a[0].localeCompare(b[0]));
      roomListEl.innerHTML = '';
      entries.forEach(([name, meta])=>{
        const div = document.createElement('div');
        div.className = 'room' + (name === currentRoom ? ' active' : '');
        div.textContent = meta.private ? `${name} (private)` : name;
        div.addEventListener('click', ()=> switchRoom(name));
        roomListEl.appendChild(div);
      });
    });
  }

  // Attach messages
  let roomMsgRef = null;
  function attachRoomListener(room){
    if (roomMsgRef) off(roomMsgRef);
    chatbox.innerHTML = '';
    roomNameEl.textContent = room;
    roomMsgRef = ref(db, `rooms/${room}/messages`);
    onChildAdded(roomMsgRef, (snap)=>{ renderMessage(snap.val(), snap.key); });
    // Presence entry
    const my = ref(db, `presence/${room}/${uid}`);
    set(my, { status: currentStatus, username: currentUser, ts: Date.now() });
    onDisconnect(my).remove();
  }

  function renderMessage(msg, key){
    if (msg.type === 'system'){
      const s = document.createElement('div'); s.className='system'; s.textContent = `— ${msg.text} —`; chatbox.appendChild(s); return;
    }
    const div = document.createElement('div');
    div.dataset.key = key;
    div.className = 'message ' + (msg.uid===uid?'self':'other');
    div.innerHTML = `<div class="username">${msg.sender || 'Anonymous'}</div><div class="text">${msg.text || ''}</div>`;
    chatbox.appendChild(div);
    chatbox.scrollTop = chatbox.scrollHeight;
  }

  // Send
  async function sendMessage(){
    const text = messageInput.value.trim();
    if (!text) return;
    const payload = { text, sender: currentUser, uid, timestamp: Date.now(), type: 'chat' };
    await push(ref(db, `rooms/${currentRoom}/messages`), payload);
    messageInput.value = '';
  }

  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keypress', e => { if (e.key === 'Enter'){ e.preventDefault(); sendMessage(); } });

  // Add room
  addRoomBtn.addEventListener('click', async ()=>{
    const name = prompt('New room name:');
    if (!name) return;
    await set(ref(db, `rooms/${name}/meta`), { owner: uid, isPrivate: true, createdAt: Date.now() });
    await set(ref(db, `userRooms/${uid}/${name}`), { private: true });
    switchRoom(name);
    await push(ref(db, `rooms/${name}/messages`), { type:'system', text:`Room "${name}" created`, timestamp: Date.now() });
  });

  // Join room
  joinRoomBtn.addEventListener('click', async ()=>{
    const name = prompt('Join room (exact name):');
    if (!name) return;
    const metaSnap = await get(ref(db, `rooms/${name}/meta`));
    if (!metaSnap.exists()){
      await push(ref(db, `rooms/${currentRoom}/messages`), { type:'system', text:`Room "${name}" not found`, timestamp: Date.now() });
      return;
    }
    const isPriv = metaSnap.val()?.isPrivate === true;
    await set(ref(db, `userRooms/${uid}/${name}`), { private: !!isPriv });
    switchRoom(name);
    await push(ref(db, `rooms/${name}/messages`), { type:'system', text:`${currentUser} joined "${name}"`, timestamp: Date.now() });
  });

  // Status box
  statusLabel.addEventListener('click', ()=>{
    statusOptions.style.display = statusOptions.style.display === 'flex' ? 'none' : 'flex';
  });
  document.querySelectorAll('.statusOption').forEach(opt=>{
    opt.addEventListener('click', async ()=>{
      currentStatus = opt.dataset.status;
      statusLabel.textContent = `Status: ${currentStatus}`;
      statusOptions.style.display = 'none';
      await set(ref(db, `presence/${currentRoom}/${uid}`), { status: currentStatus, username: currentUser, ts: Date.now() });
      await push(ref(db, `rooms/${currentRoom}/messages`), { type:'system', text:`${currentUser} has gone ${currentStatus}`, timestamp: Date.now() });
    });
  });

  // Username modal
  function showModal(m){ overlay.style.display='block'; m.style.display='block'; }
  function hideModal(m){ overlay.style.display='none'; m.style.display='none'; }
  function ensureUsername(){
    if (!localStorage.getItem('username')){
      showModal(usernameModal);
      usernameInput.focus();
    }
  }
  usernameOkBtn.addEventListener('click', async ()=>{
    const name = (usernameInput.value || '').trim() || 'Anonymous';
    currentUser = name;
    localStorage.setItem('username', currentUser);
    hideModal(usernameModal);
    renderAvatar();
    await set(ref(db, `presence/${currentRoom}/${uid}`), { status: currentStatus, username: currentUser, ts: Date.now() });
  });
  overlay.addEventListener('click', ()=> hideModal(usernameModal));

  // Switch room
  function switchRoom(room){
    currentRoom = room;
    localStorage.setItem('currentRoom', currentRoom);
    attachRoomListener(room);
    renderRoomList();
  }

  // Init
  (async function init(){
    renderAvatar();
    await seedGeneral();
    renderRoomList();
    ensureUsername();
    attachRoomListener(currentRoom);
  })();
</script>
</body>
</html>
