<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IGPHS Chatroom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --blue: #007BFF;
      --accent: #1E90FF;
      --green: #28a745;
      --bg: #000;
      --text: #fff;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: var(--blue);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    #sidebar {
      width: 240px;
      background-color: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      padding: 12px;
      box-sizing: border-box;
    }
    #sidebar h2 {
      margin: 0 0 10px;
      font-size: 16px;
      letter-spacing: 1px;
    }
    .room {
      padding: 10px;
      margin-bottom: 6px;
      background-color: #151515;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
    }
    .room.active { background-color: var(--accent); color: var(--text); }
    .room:hover { background-color: #333; }

    #addRoomBtn, #joinRoomBtn {
      margin-top: 6px;
      padding: 10px;
      background-color: var(--accent);
      color: var(--text);
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    /* Main chat area */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 12px;
      box-sizing: border-box;
    }
    #chatHeader {
      background-color: var(--bg);
      color: var(--text);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    #roomName {
      font-weight: bold;
      letter-spacing: 0.5px;
    }
    #userAvatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #fff;
      background: var(--green);
      flex-shrink: 0;
    }

    #chatbox {
      flex: 1;
      background-color: var(--bg);
      padding: 12px;
      border-radius: 12px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .message {
      max-width: 70%;
      margin: 6px 0;
      padding: 10px 14px;
      border-radius: 20px;
      animation: popIn 0.25s ease-out;
      word-wrap: break-word;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .self {
      background-color: var(--green);
      color: #fff;
      align-self: flex-end;
    }
    .other {
      background-color: #fff;
      color: #000;
      align-self: flex-start;
    }

    .username {
      font-size: 12px;
      font-weight: bold;
      opacity: 0.85;
    }
    .timestamp {
      font-size: 10px;
      opacity: 0.65;
      align-self: flex-end;
    }

    .system-message {
      text-align: center;
      color: #ccc;
      font-size: 14px;
      margin: 10px 0;
      animation: fadeIn 0.2s ease-out;
    }

    #inputArea {
      display: flex;
      margin-top: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 20px;
      padding: 8px;
      gap: 8px;
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: none;
      font-size: 16px;
      outline: none;
    }
    #sendBtn {
      padding: 10px 16px;
      border-radius: 50%;
      border: none;
      background-color: var(--green);
      color: #fff;
      font-size: 18px;
      cursor: pointer;
    }

    /* Modals */
    .modal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 18px;
      border-radius: 15px;
      width: 320px; /* ~10% visual footprint */
      z-index: 1000;
      display: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }
    .modal h3 { margin: 0 0 10px; }
    .modal input {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }
    .modal button {
      background-color: var(--blue);
      color: #fff;
      border: none;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
      font-weight: bold;
    }
    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      display: none;
    }

    @keyframes popIn {
      0% { transform: translateY(6px) scale(0.98); opacity: 0; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }
    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>ROOMS</h2>
    <div id="roomList"></div>
    <button id="addRoomBtn">+ Add Room</button>
    <button id="joinRoomBtn">Join Room</button>
  </div>

  <div id="main">
    <div id="chatHeader">
      <div id="roomName">general</div>
      <div id="userAvatar">?</div>
    </div>
    <div id="chatbox"></div>
    <div id="inputArea">
      <input type="text" id="messageInput" placeholder="Type a message..." />
      <button id="sendBtn">➤</button>
    </div>
  </div>

  <!-- Overlay -->
  <div id="overlay"></div>

  <!-- Username Modal -->
  <div id="usernameModal" class="modal">
    <h3>Choose a username</h3>
    <input type="text" id="usernameInput" placeholder="Username" />
    <input type="color" id="colorInput" value="#28a745" />
    <button id="usernameOkBtn">OK</button>
  </div>

  <!-- Add Room Modal -->
  <div id="roomModal" class="modal">
    <h3>Create a private room</h3>
    <input type="text" id="newRoomInput" placeholder="Room name" />
    <button id="createRoomBtn">OK</button>
  </div>

  <!-- Join Room Modal -->
  <div id="joinRoomModal" class="modal">
    <h3>Join a room</h3>
    <input type="text" id="joinRoomInput" placeholder="Room name" />
    <button id="joinRoomConfirmBtn">OK</button>
  </div>

  <script type="module">
    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCgkxFC2qZSTWTHfl8OgjYBNaN0rfYjaQU",
      authDomain: "igphs-acebf.firebaseapp.com",
      databaseURL: "https://igphs-acebf-default-rtdb.firebaseio.com",
      projectId: "igphs-acebf",
      storageBucket: "igphs-acebf.firebasestorage.app",
      messagingSenderId: "50789789074",
      appId: "1:50789789074:web:47598a87a8c684fea1e54b",
      measurementId: "G-KRCNVRZQFE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // UI elements
    const overlay = document.getElementById('overlay');
    const usernameModal = document.getElementById('usernameModal');
    const usernameInput = document.getElementById('usernameInput');
    const colorInput = document.getElementById('colorInput');
    const usernameOkBtn = document.getElementById('usernameOkBtn');
    const userAvatar = document.getElementById('userAvatar');

    const roomListEl = document.getElementById('roomList');
    const roomNameEl = document.getElementById('roomName');
    const addRoomBtn = document.getElementById('addRoomBtn');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const newRoomInput = document.getElementById('newRoomInput');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomInput = document.getElementById('joinRoomInput');
    const joinRoomConfirmBtn = document.getElementById('joinRoomConfirmBtn');

    const chatbox = document.getElementById('chatbox');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    // Local state
    let currentUser = localStorage.getItem('username') || null;
    let userColor = localStorage.getItem('userColor') || '#28a745';
    let currentRoom = localStorage.getItem('currentRoom') || 'general';
    let rooms = JSON.parse(localStorage.getItem('rooms') || '["general"]');

    // Modal helpers
    function showModal(modal) {
      overlay.style.display = 'block';
      modal.style.display = 'block';
    }
    function hideModal(modal) {
      overlay.style.display = 'none';
      modal.style.display = 'none';
    }

    // Avatar
    function renderAvatar() {
      const letter = (currentUser || '?').charAt(0).toUpperCase();
      userAvatar.style.background = userColor;
      userAvatar.textContent = letter;
    }

    // Rooms UI
    function renderRoomList() {
      roomListEl.innerHTML = '';
      rooms.forEach(room => {
        const div = document.createElement('div');
        div.className = 'room' + (room === currentRoom ? ' active' : '');
        div.textContent = room;
        div.dataset.room = room;
        div.addEventListener('click', () => switchRoom(room));
        roomListEl.appendChild(div);
      });
    }

    // Firebase listener map to detach/reattach on room switch
    let detachListener = null;
    function attachRoomListener(room) {
      if (detachListener) detachListener(); // simple detach (we’ll override below)
      chatbox.innerHTML = '';
      const roomRef = ref(db, `rooms/${room}/messages`);
      const unsub = onChildAdded(roomRef, (snap) => {
        const msg = snap.val();
        renderMessage(msg);
        chatbox.scrollTop = chatbox.scrollHeight;
      });
      // Store a function to clear chat and noop; Realtime DB returns no direct unsubscribe,
      // but re-attaching simply adds another handler. We prevent dupes by clearing UI before attach.
      detachListener = () => { /* noop for CDN build */ };
    }

    // Switch room
    function switchRoom(room) {
      currentRoom = room;
      localStorage.setItem('currentRoom', currentRoom);
      roomNameEl.textContent = room;
      renderRoomList();
      attachRoomListener(room);
    }

    // Render a single message
    function renderMessage(msg) {
      if (msg.type === 'system') {
        const s = document.createElement('div');
        s.className = 'system-message';
        s.textContent = `— ${msg.text} —`;
        chatbox.appendChild(s);
        return;
      }
      const div = document.createElement('div');
      const isSelf = msg.sender === (currentUser || 'Anonymous');
      div.className = `message ${isSelf ? 'self' : 'other'}`;
      const name = document.createElement('div');
      name.className = 'username';
      name.textContent = msg.sender || 'Unknown';
      const textNode = document.createElement('div');
      textNode.textContent = msg.text || '';
      const ts = document.createElement('div');
      ts.className = 'timestamp';
      ts.textContent = formatTimestamp(msg.timestamp);
      div.appendChild(name);
      div.appendChild(textNode);
      div.appendChild(ts);
      chatbox.appendChild(div);
    }

    function formatTimestamp(ts) {
      try {
        const d = new Date(ts || Date.now());
        const h = d.getHours();
        const m = d.getMinutes().toString().padStart(2, '0');
        const ampm = h >= 12 ? 'PM' : 'AM';
        const hour12 = h % 12 || 12;
        return `${hour12}:${m} ${ampm}`;
      } catch {
        return '';
      }
    }

    // Send message
    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      const payload = {
        text,
        sender: currentUser || 'Anonymous',
        timestamp: Date.now(),
        type: 'chat'
      };
      push(ref(db, `rooms/${currentRoom}/messages`), payload);
      messageInput.value = '';
    }

    // Create room (private-by-name)
    function createRoom(room) {
      if (!room) return;
      if (!rooms.includes(room)) rooms.push(room);
      localStorage.setItem('rooms', JSON.stringify(rooms));
      renderRoomList();
      switchRoom(room);
      // Post system message to Firebase to mark creation locally
      push(ref(db, `rooms/${room}/messages`), {
        type: 'system',
        text: `Room "${room}" created`,
        timestamp: Date.now()
      });
    }

    // Join room (by name; becomes accessible if you know it)
    function joinRoom(room) {
      if (!room) return;
      if (!rooms.includes(room)) rooms.push(room);
      localStorage.setItem('rooms', JSON.stringify(rooms));
      renderRoomList();
      switchRoom(room);
      push(ref(db, `rooms/${room}/messages`), {
        type: 'system',
        text: `${currentUser || 'Anonymous'} joined "${room}"`,
        timestamp: Date.now()
      });
    }

    // Events
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

    addRoomBtn.addEventListener('click', () => {
      newRoomInput.value = '';
      showModal(roomModal);
      newRoomInput.focus();
    });
    createRoomBtn.addEventListener('click', () => {
      const room = newRoomInput.value.trim();
      hideModal(roomModal);
      if (room) createRoom(room);
    });

    joinRoomBtn.addEventListener('click', () => {
      joinRoomInput.value = '';
      showModal(joinRoomModal);
      joinRoomInput.focus();
    });
    joinRoomConfirmBtn.addEventListener('click', () => {
      const room = joinRoomInput.value.trim();
      hideModal(joinRoomModal);
      if (room) joinRoom(room);
    });

    overlay.addEventListener('click', () => {
      hideModal(usernameModal);
      hideModal(roomModal);
      hideModal(joinRoomModal);
    });

    // Username setup
    function openUsernameModalIfNeeded() {
      if (!currentUser) {
        showModal(usernameModal);
        usernameInput.focus();
      } else {
        renderAvatar();
      }
    }
    usernameOkBtn.addEventListener('click', () => {
      const name = (usernameInput.value || '').trim() || 'Anonymous';
      const color = colorInput.value || '#28a745';
      currentUser = name;
      localStorage.setItem('username', currentUser);
      localStorage.setItem('userColor', color);
      userColor = color;
      hideModal(usernameModal);
      renderAvatar();
      // Announce join to current room
      push(ref(db, `rooms/${currentRoom}/messages`), {
        type: 'system',
        text: `${currentUser} joined`,
        timestamp: Date.now()
      });
    });

    // Init
    (function init() {
      if (!rooms.includes('general')) rooms.unshift('general');
      renderRoomList();
      roomNameEl.textContent = currentRoom;
      openUsernameModalIfNeeded();
      renderAvatar();
      attachRoomListener(currentRoom);
    })();

    // Optional: note offline locally (not broadcast reliably on unload)
    window.addEventListener('beforeunload', () => {
      // Avoid pushing on unload to prevent network race; will add presence later.
    });
  </script>
</body>
</html>
