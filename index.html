<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IGPHS Chatroom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --blue: #007BFF;
      --accent: #1E90FF;
      --green: #28a745;
      --bg: #000;
      --text: #fff;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: var(--blue);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    #sidebar {
      width: 260px;
      background-color: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      padding: 12px;
      box-sizing: border-box;
    }
    #sidebar h2 { margin: 0 0 10px; font-size: 16px; }
    .room {
      padding: 10px;
      margin-bottom: 6px;
      background-color: #151515;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
    }
    .room.active { background-color: var(--accent); color: var(--text); }
    .room:hover { background-color: #333; }
    .privateTag { font-size: 10px; opacity: 0.7; margin-left: 8px; }

    #addRoomBtn, #joinRoomBtn {
      margin-top: 6px;
      padding: 10px;
      background-color: var(--accent);
      color: var(--text);
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    /* Main chat area */
    #main { flex: 1; display: flex; flex-direction: column; padding: 12px; box-sizing: border-box; }
    #chatHeader {
      background-color: var(--bg);
      color: var(--text);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    #roomTitle { display: flex; align-items: center; gap: 10px; }
    #roomName { font-weight: bold; letter-spacing: 0.5px; }
    #onlineStatus { display: flex; align-items: center; gap: 6px; font-size: 13px; opacity: 0.9; }
    #statusDot { width: 10px; height: 10px; border-radius: 50%; background: #00FF00; }

    #userControls { display: flex; align-items: center; gap: 10px; }
    #userAvatar {
      width: 32px; height: 32px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; color: #fff; background: var(--green);
      flex-shrink: 0;
    }
    #settingsGear { cursor: pointer; font-size: 18px; }

    #chatbox {
      flex: 1; background-color: var(--bg);
      padding: 12px; border-radius: 12px;
      overflow-y: auto; display: flex; flex-direction: column;
    }

    .message {
      max-width: 70%;
      margin: 6px 0;
      padding: 10px 14px;
      border-radius: 20px;
      animation: popIn 0.25s ease-out;
      word-wrap: break-word;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .self { background-color: var(--green); color: #fff; align-self: flex-end; }
    .other { background-color: #fff; color: #000; align-self: flex-start; }

    .username { font-size: 12px; font-weight: bold; opacity: 0.85; }
    .timestamp { font-size: 10px; opacity: 0.65; align-self: flex-end; }
    .system-message { text-align: center; color: #ccc; font-size: 14px; margin: 10px 0; animation: fadeIn 0.2s ease-out; }

    #inputArea {
      display: flex; margin-top: 10px;
      background: rgba(0,0,0,0.2); border-radius: 20px; padding: 8px; gap: 8px;
    }
    #messageInput { flex: 1; padding: 10px; border-radius: 20px; border: none; font-size: 16px; outline: none; }
    #sendBtn { padding: 10px 16px; border-radius: 50%; border: none; background-color: var(--green); color: #fff; font-size: 18px; cursor: pointer; }

    /* Status drop-up */
    #statusBox {
      position: fixed; bottom: 10px; left: 10px;
      background-color: var(--bg); color: var(--text);
      border: 1px solid var(--accent); border-radius: 10px;
      font-size: 14px; cursor: pointer; z-index: 100;
    }
    #statusLabel { padding: 8px 12px; }
    #statusOptions { display: none; flex-direction: column; border-top: 1px solid var(--accent); }
    .statusOption { padding: 8px 12px; border-top: 1px solid #333; background-color: #111; }
    .statusOption:hover { background-color: #222; }

    /* Modals */
    .modal {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff; padding: 18px; border-radius: 15px;
      width: 340px; z-index: 1000; display: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }
    .modal h3 { margin: 0 0 10px; }
    .modal input {
      width: 100%; padding: 10px; margin: 6px 0;
      border-radius: 10px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box;
    }
    .modal .row { display: flex; align-items: center; gap: 10px; }
    .modal .avatarPreview {
      width: 36px; height: 36px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-weight: bold; background: var(--green);
    }
    .modal button {
      background-color: var(--blue); color: #fff; border: none;
      padding: 10px 12px; border-radius: 10px; cursor: pointer; margin-top: 10px; width: 100%; font-weight: bold;
    }
    #overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 999; display: none;
    }

    @keyframes popIn {
      0% { transform: translateY(6px) scale(0.98); opacity: 0; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }
    @keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>ROOMS</h2>
    <div id="roomList"></div>
    <button id="addRoomBtn">+ Add Room</button>
    <button id="joinRoomBtn">Join Room</button>
  </div>

  <div id="main">
    <div id="chatHeader">
      <div id="roomTitle">
        <div id="roomName">General</div>
        <div id="onlineStatus"><div id="statusDot"></div><span id="onlineCount">0 online</span></div>
      </div>
      <div id="userControls">
        <div id="userAvatar">?</div>
        <div id="settingsGear" title="Settings">⚙️</div>
      </div>
    </div>
    <div id="chatbox"></div>
    <div id="inputArea">
      <input type="text" id="messageInput" placeholder="Type a message..." />
      <button id="sendBtn">➤</button>
    </div>
  </div>

  <!-- Status drop-up -->
  <div id="statusBox">
    <div id="statusLabel">Status: Online</div>
    <div id="statusOptions">
      <div class="statusOption" data-status="Online">Online</div>
      <div class="statusOption" data-status="DND">Do Not Disturb</div>
      <div class="statusOption" data-status="Offline">Offline</div>
    </div>
  </div>

  <!-- Overlay -->
  <div id="overlay"></div>

  <!-- Username Modal -->
  <div id="usernameModal" class="modal">
    <h3>Choose a username</h3>
    <div class="row">
      <input type="text" id="usernameInput" placeholder="Username" />
      <div id="avatarPreview" class="avatarPreview">?</div>
    </div>
    <input type="color" id="colorInput" value="#28a745" />
    <button id="usernameOkBtn">OK</button>
  </div>

  <!-- Add Room Modal -->
  <div id="roomModal" class="modal">
    <h3>Create a private room</h3>
    <input type="text" id="newRoomInput" placeholder="Room name" />
    <button id="createRoomBtn">OK</button>
  </div>

  <!-- Join Room Modal -->
  <div id="joinRoomModal" class="modal">
    <h3>Join a room (exact name)</h3>
    <input type="text" id="joinRoomInput" placeholder="Room name" />
    <button id="joinRoomConfirmBtn">OK</button>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <h3>Change username</h3>
    <input type="text" id="newUsernameInput" placeholder="New username" />
    <button id="settingsOkBtn">Save</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getDatabase, ref, set, push, onChildAdded, onValue, onDisconnect, off } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCgkxFC2qZSTWTHfl8OgjYBNaN0rfYjaQU",
      authDomain: "igphs-acebf.firebaseapp.com",
      databaseURL: "https://igphs-acebf-default-rtdb.firebaseio.com",
      projectId: "igphs-acebf",
      storageBucket: "igphs-acebf.firebasestorage.app",
      messagingSenderId: "50789789074",
      appId: "1:50789789074:web:47598a87a8c684fea1e54b",
      measurementId: "G-KRCNVRZQFE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Elements
    const overlay = document.getElementById('overlay');
    const usernameModal = document.getElementById('usernameModal');
    const usernameInput = document.getElementById('usernameInput');
    const colorInput = document.getElementById('colorInput');
    const usernameOkBtn = document.getElementById('usernameOkBtn');

    const settingsGear = document.getElementById('settingsGear');
    const settingsModal = document.getElementById('settingsModal');
    const newUsernameInput = document.getElementById('newUsernameInput');
    const settingsOkBtn = document.getElementById('settingsOkBtn');

    const avatarPreview = document.getElementById('avatarPreview');
    const userAvatar = document.getElementById('userAvatar');

    const roomListEl = document.getElementById('roomList');
    const roomNameEl = document.getElementById('roomName');
    const addRoomBtn = document.getElementById('addRoomBtn');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const newRoomInput = document.getElementById('newRoomInput');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomInput = document.getElementById('joinRoomInput');
    const joinRoomConfirmBtn = document.getElementById('joinRoomConfirmBtn');

    const chatbox = document.getElementById('chatbox');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    const statusBox = document.getElementById('statusBox');
    const statusLabel = document.getElementById('statusLabel');
    const statusOptions = document.getElementById('statusOptions');
    const statusDot = document.getElementById('statusDot');
    const onlineCountEl = document.getElementById('onlineCount');

    // Identity and local state
    let uid = localStorage.getItem('uid');
    if (!uid) { uid = 'u_' + Math.random().toString(36).slice(2, 10); localStorage.setItem('uid', uid); }
    let currentUser = localStorage.getItem('username') || null;
    let userColor = localStorage.getItem('userColor') || '#28a745';
    let currentStatus = 'Online';
    let currentRoom = localStorage.getItem('currentRoom') || 'General'; // Default room

    // Modal helpers
    function showModal(modal) { overlay.style.display = 'block'; modal.style.display = 'block'; }
    function hideModal(modal) { overlay.style.display = 'none'; modal.style.display = 'none'; }

    // Avatar
    function renderAvatar() {
      const letter = (currentUser || '?').charAt(0).toUpperCase();
      userAvatar.style.background = userColor;
      userAvatar.textContent = letter;
      avatarPreview.style.background = userColor;
      avatarPreview.textContent = letter;
    }
    usernameInput.addEventListener('input', () => {
      avatarPreview.textContent = (usernameInput.value || '?').charAt(0).toUpperCase();
    });
    colorInput.addEventListener('input', () => {
      avatarPreview.style.background = colorInput.value;
    });

    // Rooms visibility model:
    // userRooms/{uid}/{roomName}: { private: boolean } appears in sidebar
    // rooms/{roomName}/meta: { owner, isPrivate, createdAt }
    // rooms/{roomName}/messages: stream
    let userRoomsUnsub = null;
    function renderRoomList() {
      if (userRoomsUnsub) off(userRoomsUnsub);
      const userRoomsRef = ref(db, `userRooms/${uid}`);
      userRoomsUnsub = userRoomsRef;
      onValue(userRoomsRef, (snap) => {
        const roomsObj = snap.val() || {};
        // Ensure General in sidebar
        if (!roomsObj['General']) {
          set(ref(db, `userRooms/${uid}/General`), { private: false });
        }
        const entries = Object.entries(roomsObj).sort((a,b) => a[0].localeCompare(b[0]));
        roomListEl.innerHTML = '';
        entries.forEach(([name, meta]) => {
          const div = document.createElement('div');
          div.className = 'room' + (name === currentRoom ? ' active' : '');
          const label = document.createElement('span'); label.textContent = name;
          const privTag = document.createElement('span'); privTag.className = 'privateTag'; privTag.textContent = meta.private ? '(private)' : '';
          div.appendChild(label); div.appendChild(privTag);
          div.addEventListener('click', () => {
            switchRoom(name);
          });
          roomListEl.appendChild(div);
        });
        // keep active highlight accurate even if list re-renders
        updateActiveHighlight();
      });
    }
    function updateActiveHighlight() {
      document.querySelectorAll('.room').forEach(el => {
        const label = el.firstChild?.textContent || '';
        el.classList.toggle('active', label === currentRoom);
      });
    }

    // Presence: presence/{room}/{uid} = { status, username, ts }
    let presenceUnsub = null;
    function attachPresence(room) {
      if (presenceUnsub) off(presenceUnsub);
      const presRef = ref(db, `presence/${room}`);
      presenceUnsub = presRef;
      onValue(presRef, (snap) => {
        const pres = snap.val() || {};
        const count = Object.values(pres).filter(p => p && (p.status === 'Online' || p.status === 'DND')).length;
        onlineCountEl.textContent = `${count} online`;
      });
      const myPresRef = ref(db, `presence/${room}/${uid}`);
      set(myPresRef, { status: currentStatus, username: currentUser || 'Anonymous', ts: Date.now() });
      onDisconnect(myPresRef).remove();
    }

    // Room messages listener
    let currentRoomRef = null;
    function attachRoomListener(room) {
      // Detach previous listener to prevent duplicates
      if (currentRoomRef) off(currentRoomRef);
      chatbox.innerHTML = '';
      roomNameEl.textContent = room;
      currentRoomRef = ref(db, `rooms/${room}/messages`);
      onChildAdded(currentRoomRef, (snap) => {
        const msg = snap.val();
        renderMessage(msg);
        chatbox.scrollTop = chatbox.scrollHeight;
      });
      attachPresence(room);
      updateActiveHighlight();
    }

    // Switch room
    function switchRoom(room) {
      currentRoom = room;
      localStorage.setItem('currentRoom', currentRoom);
      attachRoomListener(room);
    }

    // Render message
    function renderMessage(msg) {
      if (msg.type === 'system') {
        const s = document.createElement('div');
        s.className = 'system-message';
        s.textContent = `— ${msg.text} —`;
        chatbox.appendChild(s);
        return;
      }
      const div = document.createElement('div');
      const isSelf = msg.uid === uid;
      div.className = `message ${isSelf ? 'self' : 'other'}`;

      const name = document.createElement('div');
      name.className = 'username';
      name.textContent = msg.sender || 'Unknown';

      const textNode = document.createElement('div');
      textNode.textContent = msg.text || '';

      const ts = document.createElement('div');
      ts.className = 'timestamp';
      ts.textContent = formatTimestamp(msg.timestamp);

      div.appendChild(name);
      div.appendChild(textNode);
      div.appendChild(ts);
      chatbox.appendChild(div);
    }

    function formatTimestamp(ts) {
      try {
        const d = new Date(ts || Date.now());
        const h = d.getHours();
        const m = d.getMinutes().toString().padStart(2, '0');
        const ampm = h >= 12 ? 'PM' : 'AM';
        const hour12 = h % 12 || 12;
        return `${hour12}:${m} ${ampm}`;
      } catch { return ''; }
    }

    // Send message
    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !currentUser) return;
      const payload = { text, sender: currentUser, uid, timestamp: Date.now(), type: 'chat' };
      push(ref(db, `rooms/${currentRoom}/messages`), payload);
      messageInput.value = '';
    }

    // System message
    function postSystemMessage(room, text) {
      push(ref(db, `rooms/${room}/messages`), { type: 'system', text, timestamp: Date.now() });
    }

    // Create private room (visible only to creator until shared)
    function createRoomByName(roomName) {
      const name = (roomName || '').trim();
      if (!name) return;
      set(ref(db, `rooms/${name}/meta`), { owner: uid, isPrivate: true, createdAt: Date.now() });
      set(ref(db, `userRooms/${uid}/${name}`), { private: true });
      postSystemMessage(name, `Room "${name}" created`);
      switchRoom(name);
    }

    // Join room by exact name (once joined, it appears in your sidebar permanently)
    function joinRoomByName(roomName) {
      const name = (roomName || '').trim();
      if (!name) return;
      onValue(ref(db, `rooms/${name}/meta`), (snap) => {
        const meta = snap.val() || {};
        const isPriv = meta.isPrivate === true;
        set(ref(db, `userRooms/${uid}/${name}`), { private: !!isPriv });
      }, { onlyOnce: true });
      postSystemMessage(name, `${currentUser || 'Anonymous'} joined "${name}"`);
      switchRoom(name);
    }

    // Status (Online/DND/Offline)
    statusLabel.addEventListener('click', () => {
      statusOptions.style.display = statusOptions.style.display === 'flex' ? 'none' : 'flex';
    });
    document.querySelectorAll('.statusOption').forEach(opt => {
      opt.addEventListener('click', () => {
        const status = opt.dataset.status;
        const prev = currentStatus;
        currentStatus = status;
        statusLabel.textContent = `Status: ${currentStatus}`;
        statusOptions.style.display = 'none';
        statusDot.style.backgroundColor =
          currentStatus === 'Online' ? '#00FF00' :
          currentStatus === 'DND' ? 'red' : 'gray';
        set(ref(db, `presence/${currentRoom}/${uid}`), { status: currentStatus, username: currentUser || 'Anonymous', ts: Date.now() });
        if (prev !== currentStatus) postSystemMessage(currentRoom, `${currentUser || 'Anonymous'} has gone ${currentStatus}`);
      });
    });

    // Overlay closes modals
    overlay.addEventListener('click', () => {
      hideModal(usernameModal);
      hideModal(settingsModal);
      hideModal(roomModal);
      hideModal(joinRoomModal);
    });

    // Buttons
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

    addRoomBtn.addEventListener('click', () => {
      newRoomInput.value = '';
      showModal(roomModal);
      newRoomInput.focus();
    });
    createRoomBtn.addEventListener('click', () => {
      const name = newRoomInput.value.trim();
      hideModal(roomModal);
      if (name) createRoomByName(name);
    });

    joinRoomBtn.addEventListener('click', () => {
      joinRoomInput.value = '';
      showModal(joinRoomModal);
      joinRoomInput.focus();
    });
    joinRoomConfirmBtn.addEventListener('click', () => {
      const name = joinRoomInput.value.trim();
      hideModal(joinRoomModal);
      if (name) joinRoomByName(name);
    });

    // Settings gear: change username, broadcast rename
    settingsGear.addEventListener('click', () => {
      newUsernameInput.value = '';
      showModal(settingsModal);
      newUsernameInput.focus();
    });
    settingsOkBtn.addEventListener('click', () => {
      const oldName = currentUser || 'Anonymous';
      const newName = (newUsernameInput.value || '').trim();
      if (!newName) return;
      currentUser = newName;
      localStorage.setItem('username', currentUser);
      renderAvatar();
      hideModal(settingsModal);
      postSystemMessage(currentRoom, `${oldName} has set new username to ${currentUser}`);
      set(ref(db, `presence/${currentRoom}/${uid}`), { status: currentStatus, username: currentUser, ts: Date.now() });
    });

    // Username setup
    function openUsernameModalIfNeeded() {
      if (!currentUser) {
        usernameInput.value = '';
        avatarPreview.style.background = userColor;
        avatarPreview.textContent = '?';
        showModal(usernameModal);
        usernameInput.focus();
      } else {
        renderAvatar();
      }
    }
    usernameOkBtn.addEventListener('click', () => {
      const name = (usernameInput.value || '').trim() || 'Anonymous';
      const color = colorInput.value || '#28a745';
      currentUser = name;
      userColor = color;
      localStorage.setItem('username', currentUser);
      localStorage.setItem('userColor', userColor);
      hideModal(usernameModal);
      renderAvatar();
      // Ensure General visible
      set(ref(db, `userRooms/${uid}/General`), { private: false });
      // Announce join
      postSystemMessage(currentRoom, `${currentUser} joined`);
      // Presence
      set(ref(db, `presence/${currentRoom}/${uid}`), { status: currentStatus, username: currentUser, ts: Date.now() });
      onDisconnect(ref(db, `presence/${currentRoom}/${uid}`)).remove();
    });

    // Seed General metadata if missing
    function seedGeneral() {
      onValue(ref(db, `rooms/General/meta`), (snap) => {
        if (!snap.exists()) {
          set(ref(db, `rooms/General/meta`), { owner: 'system', isPrivate: false, createdAt: Date.now() });
        }
      }, { onlyOnce: true });
      set(ref(db, `userRooms/${uid}/General`), { private: false });
    }

    // Init
    (function init() {
      seedGeneral();
      renderRoomList();
      roomNameEl.textContent = currentRoom;
      openUsernameModalIfNeeded();
      renderAvatar();
      attachRoomListener(currentRoom);
    })();

    // Cleanup handled by onDisconnect; avoid unload pushes
    window.addEventListener('beforeunload', () => {});
  </script>
</body>
</html>
